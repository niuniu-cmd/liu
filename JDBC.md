#连接池JDBC
###什么是JDBC
Java连接数据库和执行SQL语句的API
###什么是DBCP
DataBase Connection Pool，数据库连接池。数据连接池就是连接数据库的进程的集合。一般的SQL 执行都是“建立数据库连接--执行SQL--关闭数据库连接”，对于频繁连接数据库应用，这样反复“建立连接--关闭连接”是非常耗系统资源的。
##什么是连接池

连接池 负责分配，管理和数据的释放，他允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个。
 
##为什么要使用连接池：
     数据可连接是一种有限且昂贵的资源，在多用户网页程序中体现的突出。一个数据库连接对象对应一个物理     数据库的连接，每一次创建，关闭连接。会造成系统的性能低下。
        连接池就是在程序启动时建立足够的连接，将这些连接组成以一个池。由应用程序动态的进行申请，使用，释放连接。
      对于并发请求，应该在请求队列中排队等待，并且应用程序的可以根据连接池的使用情况，动态的增加或减少连接数。
##连接池的优点
###1：资源重用：
  
   由于数据库连接得到了重用，避免了频繁的创建，释放连接，而造成的系统的消耗。另一方面也减少了内存碎片以及数据库临时的进程数量，从而增加了系统运行环境的平稳，
###2：更快的系统响应速度

   数据库连接池在初始化中，已经创建了若干个连接置于连接池中备用。此时连接的初始化已经完成，对于请求业务而言可以直接连接，避免了数据库连接的初始化进而释放的过程的时间，
###3：新的资源分配手段
 
  对于多个应用程序共享同一个数据库而言，可以再通用层进行数据库的配置，实现数据库连接池技术。
###4：统一的连接管理，避免了数据库连接的泄露

   在较完备的数据库连接池实现中，可以根据预先的连接占用超时设定，强制收回被占用的连接。而避免了常规数据库连接操作中可能出现的资源泄露，
##传统的连接机制与数据库连接池的运行机制区别
###不适用连接池
![](nojdbc.png)<p>
传统的步骤：

	1：tcp建立连接三次握手
	2：sql认证的三系握手
	3：真正的sql执行
	4：sql关闭
	5：tcp断开连接四次挥手
优点：
	
	实现简单
缺点：
	1：网络IO高
	2：数据库负载高，每个新连接都重复上述步骤
	3：响应时间长
	4：频繁的创建，释放连接，产生大量对象，GC频繁
	5：在关闭连接后，会出现大量TIME_WAIT 的TCP状态（在2个MSL之后关闭）
	     

###使用用连接池
![](jdcb.png)<p>
###步骤：

	第一次访问时，需要建立连接，但之后的访问，会从池使用连接，直接执行sql语句
###优点：

	1：减少网络开销
	2：系统的性能提升
	3：没有没了麻烦的TIME_WAIT状态
##连接池的工作原理：
 
1：连接池的建立<br>
2：连接池连接的使用管理<br>
3：连接池的关闭<br>

###连接池的建立
在系统初始化时，连接池会根据配置建立，并在池中创建几个连接对象。以便使用时在连接池中获取。
连接池的连接不能随便创建，销毁。这样影响系统的性能
###连接池连接的使用管理
客户请求连接时，首先查看池中是否有空闲的连接，如果有空闲的连接，则将连接分配给客户。如果没有连接，查看当前连接数是否已经达到最大值。如果没有达到最大值，就创建连接给用户。如果达到了最大值，就按最大设定的等待时间进行等待，若超过了最大等待时间，就抛出异常
###连接池的关闭
当程序退出时，就关闭所有的连接，释放相关的资源。
##连接池主要参数
1 最小连接数：连接池一直保持的连接，如果程序使用量不大，就会造成资源的浪费。<br>
2 最大连接数：连接池最多可以申请的连接数。如果程序的请求次数大于连接池最大连接数，就会进入等待队列进行等待。<br>
3 最大空闲时间：连接池中连接可空闲的时间,单位为秒 超过此时间的连接会被释放到连接池中,针对未被close的活动连接。<br>
4：获取连接超时的时间：在等待队列里最长等到的时间。<br>
5：超时重试连接次数：在等待队列里超过了最长等到的时间，就会尽心重新连接。<br>
##连接池注意事项
###并发问题：

  为了连接管理具有最大的通用性，要考虑多线程环境，机并发问题。每个语言提供了对并发管理的支持。例如Java的synchronized lock等
###事务处理
   事务具有原子性，此时要求数据库操作符合ALL-OR-NOTHING”原则，即sql语句要么全做，要么全不做<br>
   当两个线程公用一个Connection对象时，每个线程都有自己要处理的事务。即使connection类提供了相应的事物支持。但是仍不能确定数据库操作对应的树那个事物。所以<br>解决方案每个事物独占一个连接
###连接池的分配与释放
   接池的分配与释放，对系统的性能有很大的影响。合理的分配与释放，可以提高连接的复用度，从而降低建立新连接的开销，同时还可以加快用户的访问速度。 <br>
   对于连接管理可以使用一个list 。把已经创建的连接放到list统一管理。当用户请求时，遍历list看看有没有可分配的链接，有就分配给用户，没有就抛出异常让请求去排队
###连接池的配置与维护
 系统采用最小连接数，最大连接数等控制连接池的连接<br>
若连接数创建过多，系统启动慢，但是响应快。创建数过少，启动快但是响应慢。说以<br>
  最小连接数是系统启动时创建的，最大连接数程序实际使用时设置的。具体设置多少，看系统的访问量。
###动态和静态保持最小连接数
动态：
	每隔一段时间对连接池进行检测，若发现连接数小于最小连接数，就补充响应的连接数。
静态
	当发现空闲连接不够了再去检查。
###第一，二代连接池
第一代一般采用单线程同步二代多采用多线程异步架构
####彻底死掉的C3P0
	C3P0功能简单易用，稳定性好这是它的优点，但是性能上的缺点却让它彻底被打入冷宫。C3P0的性能很差，差到即便是同时代的产品相比它也是垫底的，更不用和Druid、HikariCP等相比了。正常来讲，有问题很正常，改就是了，但c3p0最致命的问题就是架构设计过于复杂，让重构变成了一项不可能完成的任务。随着国内互联网大潮的涌起，性能有硬伤的c3p0彻底的退出了历史舞台。
####咸鱼翻身的DBCP
	DBCP（DataBase Connection Pool）属于Apache顶级项目Commons中的核心子项目（最早在Jakarta Commons里就有）,在Apache的生态圈中的影响里十分广泛，比如最为大家所熟知的Tomcat就在内部集成了DBCP，实现JPA规范的OpenJPA，也是默认集成DBCP的。但DBCP并不是独立实现连接池功能的，它内部依赖于Commons中的另一个子项目Pool，连接池最核心的“池”，就是由Pool组件提供的，因此，DBCP的性能实际上就是Pool的性能，
####性能无敌的HikariCP
	字节码精简：优化代码，直到编译后的字节码最少，这样，CPU缓存可以加载更多的程序代码；
	优化代理和拦截器：减少代码，例如HikariCP的Statement proxy只有100行代码；
	自定义数组类型（FastStatementList）代替ArrayList：避免每次get()调用都要进行range check，避免调用remove()时的从头到尾的扫描；
	自定义集合类型（ConcurrentBag）：提高并发读写的效率；
	其他缺陷的优化，比如对于耗时超过一个CPU时间片的方法调用的研究（但没说具体怎么优化）。
###功能全面的Druid
它除了提供性能卓越的连接池功能外，还集成了SQL监控，黑名单拦截等功能，用它自己的话说，Druid是“为监控而生”
	强大的监控特性，通过Druid提供的监控功能，可以清楚知道连接池和SQL的工作情况。
	a. 监控SQL的执行时间、ResultSet持有时间、返回行数、更新行数、错误次数、错误堆栈信息；

	b. SQL执行的耗时区间分布。什么是耗时区间分布呢？比如说，某个SQL执行了1000次，其中0~1毫秒区间50次，1~10毫秒800次，10~100毫秒100次，100~1000毫秒30次，1~10秒15次，10秒以上5次。通过耗时区间分布，能够非常清楚知道SQL的执行耗时情况；

	c. 监控连接池的物理连接创建和销毁次数、逻辑连接的申请和关闭次数、非空等待次数、PSCache命中率等。

	方便扩展。Druid提供了Filter-Chain模式的扩展API，可以自己编写Filter拦截JDBC中的任何方法，可以在上面做任何事情，比如说性能监控、SQL审计、用户名密码加密、日志等等。
	Druid集合了开源和商业数据库连接池的优秀特性，并结合阿里巴巴大规模苛刻生产环境的使用经验进行优化。
###JDBC最常用的资源
---Connection：数据库连接声明<br>
---Statement：会话声明<br>
---Resultset:结果集游标<br>
关系图：<p>
![](Cooection.png)<p>
如要想判断连接Connerction是否超时，则要确定其Statement是否超时，同样确定其Statement是否超时，要确定resultSet是否超时。在关闭Connection前，需要关闭所有相关的Statement和ResultSet。
